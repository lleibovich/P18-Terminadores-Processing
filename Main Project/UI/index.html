<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>P18-Terminadores-Processing!</title>
    <!--Import Google Icon Font-->
    <!--<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">-->
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="node_modules/materialize-css/dist/css/materialize.min.css"  media="screen,projection"/>

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style type="text/css">
      .row.slim {
        margin-bottom: 2px;
      }
      .btn.slim {
        height: 22px;
        line-height: 22px;
      }
      .col.s10.border {
        border: 1px;
      }
    </style>
  </head>
  <body>
    <nav class="nav-extended">
      <div class="nav-wrapper">
        <a href="#" class="brand-logo left">P18 - Terminadores - Processing</a>
      </div>
      <div class="nav-content">
        <ul class="tabs tabs-transparent">
          <li class="tab"><a href="#vars_words">Palabras</a></li>
          <li class="tab"><a href="#vars_colors">Colores</a></li>
          <li class="tab"><a href="#cfgs">Configuración</a></li>
        </ul>
        <a href="#" id="btnPlay" class="brand-logo right waves-effect waves-light- btn">Jugar!</a>
      </div>
    </nav>
    <div id="vars_words" class="col s12">
      <div class="row">
        <div class="col s6">
          <h2>Miedos</h2>
          <div class="row slim">
            <div class="col s2">Palabra:</div>
            <div class="col s8"><input id="txtAddFear" type="text" style="width: 100%"/></div>
            <div class="col s2"><a id="btnAddFear" class="waves-effect waves-light- btn">+</a></div>
          </div>
          <div class="row slim">
            <div class="col s2">Ingresadas:</div>
            <div class="col s10">
              <ul id="ulFearsWords" style="max-height: 250px; overflow-y: auto;"></ul>
            </div>
          </div>
        </div>
        <div class="col s6">
          <h2>Fortalezas</h2>
          <div class="row slim">
            <div class="col s2">Palabra:</div>
            <div class="col s8"><input id="txtAddStrength" type="text" style="width: 100%"/></div>
            <div class="col s2"><a id="btnAddStrength" class="waves-effect waves-light- btn">+</a></div>
          </div>
          <div class="row slim">
            <div class="col s2">Ingresadas:</div>
            <div class="col s10" style="max-height: 250px; overflow-y: auto;">
              <ul id="ulStrengthsWords"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="vars_colors" class="col s12">
      <div class="row slim">
        <div class="col s12">
          <h2>Color de Fondo</h2>
          <input id="colBackground" type="color" style="width: 25%" value="#000000"/>
        </div>
      </div>
      <div class="row">
        <div class="col s6">
          <h2>Miedos</h2>
          <div class="row">
            <div class="col s2">Color:</div>
            <div class="col s10"><input id="colAddFear" type="color" style="width: 100%" value="#ff0000"/></div>
          </div>
          <div class="row">
            <div class="col s2">Seleccionados:</div>
            <div class="col s10">
              <ul id="ulFearsColors"></ul>
            </div>
          </div>
        </div>
        <div class="col s6">
          <h2>Fortalezas</h2>
          <div class="row">
            <div class="col s2">Color:</div>
            <div class="col s10"><input id="colAddStrength" type="color" style="width: 100%" value="#00ff00"/></div>
          </div>
          <div class="row">
            <div class="col s2">Seleccionados:</div>
            <div class="col s10">
              <ul id="ulStrengthsColors"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="cfgs" class="col s12">
      <div class="row">
        <div class="row"><div class="col s12"><h2>Configuraciones</h2></div></div>
        <div class="input-field col s2">
          <select id="selSensorType">
            <option value="KINECT">Kinect</option>
            <option value="RANDOM">Aleatorio</option>
          </select>
          <label>Sensor:</label>
        </div>
        <div class="input-field col s2">
          <input id="txtFontName" type="text" value="Arial" />
          <label>Fuente</label>
        </div>
        <div class="input-field col s2">
          <input id="txtFontSize" type="number" step="1" value="48" />
          <label>Tamaño de Fuente</label>
        </div>
        <div class="input-field col s2">
          <input id="txtDisalignConversionFactor" type="number" value="100" />
          <label>Sensibilidad sensor</label>
        </div>
        <div class="input-field col s2">
          <input id="txtDisalignIntervalMs" type="number" value="50" />
          <label>Intervalo sensado (ms)
        </div>
        <div class="input-field col s2">
          <select id="selLocationType">
            <option value="FIXED">Organizado</option>
            <option value="RANDOM">Aleatorio</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="input-field col s2">
          <select id="selProjectorName" disabled></select>
          <label>Proyector</label>
        </div>
        <div class="input-field col s2">
          <select id="selProjectorResolution" disabled></select>
          <label>Resolución proyector</label>
        </div>
      </div>
    </div>


    <script>
      // You can also require other files to run in this process
      require('./renderer.js')
    </script>
    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="node_modules/hammerjs/hammer.min.js"></script>
    <script type="text/javascript" src="node_modules/materialize-css/dist/js/materialize.min.js"></script>

    <script type="text/javascript">
      // Constants
      var MAX_WORDS_FEARS = 15;
      var MAX_WORDS_STRENGTHS = 15;
    </script>
    <script type="text/javascript">
      (function($) {
        $.fn.onEnter = function(func) {
          this.bind('keypress', function(e) {
            if (e.keyCode == 13) func.apply(this, [e]);
          });
          return this;
        };
      })(jQuery);
    </script>
    <script type="text/javascript">
      $().ready(function() {
        // Redirect to vars page by default
        window.location.hash="#vars_words";
        $("select").material_select();
        $("#txtAddFear").onEnter(function(e) {
          $("#btnAddFear").trigger("click");
        });
        $("#txtAddStrength").onEnter(function(e) {
          $("#btnAddStrength").trigger("click");
        });
        $("#btnAddFear").on("click", function(e) {
          var fear = $("#txtAddFear").val();
          if (fear == "") return;
          if ($("#ulFearsWords").children().length >= MAX_WORDS_FEARS) {
            alert("No se pueden agregar miedos, llegó al máximo.", "Máximo alcanzado");
            return;
          }
          addFearWord(fear);
          $("#txtAddFear").val("");
        });
        $("#btnAddStrength").on("click", function(e) {
          var strength = $("#txtAddStrength").val();
          if (strength == "") return;
          if ($("#ulStrengthsWords").children().length >= MAX_WORDS_STRENGTHS) {
            alert("No se pueden agregar fortalezas, llegó al máximo.", "Máximo alcanzado");
            return;
          }
          addStrengthWord(strength);
          $("#txtAddStrength").val("");
        });
        $("#colAddFear").on("change", function(e) {
          console.log(getRgbArrayFromElement($(this)));
          addFearColor($(this).val());
        });
        $("#colAddStrength").on("change", function(e) {
          console.log(getRgbArrayFromElement($(this)));
          addStrengthColor($(this).val());
        });
        $("#btnPlay").on("click", function(e) {
          const remote = require('electron').remote
          const dialog = remote.dialog;

          var fs = require("fs");
          console.log(buildCfgString());
          var child = require('child_process').exec;
          const appL = require('electron').remote.app;
          var executablePath = appL.getAppPath() + "\\app\\";
          fs.writeFile(executablePath + "cfg.txt", buildCfgString(), (err) => {
            if(err){
              alert("No se pudo guardar la configuración: "+ err.message);
              dialog.showErrorBox("No se pudo guardar la configuración", err.message);
            } else {
              //alert("The file has been succesfully saved");
              child("start /d \"" + executablePath + "\" Main.exe", function(err, data) {
                if(err){
                  console.error(err);

                  dialog.showErrorBox("No se pudo guardar la configuración", err);
                  return;
                }
                console.log(data.toString());
              });
            }
          });
        })
      });
    </script>
    <script type="text/javascript">
      function getColorString(rgbArray) {
        return rgbArray[0] + ";" + rgbArray[1] + ";" + rgbArray[2];
      }
      function getUlColorsString(ulName) {
        var str = "";
        $("#" + ulName + " li .s10").each(function(i) {
          str += getColorString(getRgbArrayFromHex($(this).html())) + "|";
        });
        str = str.replace(/\|\s*$/, "");
        return str;
      }
      function getUlWordsString(ulName) {
        var str = "";
        $("#" + ulName + " li .s10").each(function(i) {
          str += $(this).html() + ";";
        });
        str = str.replace(/\;\s*$/, "");
        return str;
      }
      function buildCfgString() {
        var os = require("os");
        var fearsWordsString = getUlWordsString("ulFearsWords");
        var strengthWordsString = getUlWordsString("ulStrengthsWords");
        var fearsColorsStrnig = getUlColorsString("ulFearsColors");
        var strengthColorsString = getUlColorsString("ulStrengthsColors");
        var backgroundColorString = getColorString(getRgbArrayFromElement($("#colBackground")));
        var cfgString = "";
        cfgString += "AnimationType=" + $("#selAnimationType").val() + os.EOL;
        cfgString += "SensorType=" + $("#selSensorType").val() + os.EOL;
        cfgString += "CameraName=" + "ABC" + os.EOL;
        cfgString += "Fears=" + fearsWordsString + os.EOL;
        cfgString += "FearsColors=" + fearsColorsStrnig + os.EOL;
        cfgString += "Strengths=" + strengthWordsString + os.EOL;
        cfgString += "StrengthsColors=" + fearsColorsStrnig + os.EOL;
        cfgString += "ProjectorResolution=" + "x,y" + os.EOL;
        cfgString += "ProjectorName=" + "ABC" + os.EOL;
        cfgString += "FontName=" + $("#txtFontName").val() + os.EOL;
        cfgString += "FontSize=" + $("#txtFontSize").val() + os.EOL;
        cfgString += "DisalignConversionFactor=" + $("#txtDisalignConversionFactor").val() + os.EOL;
        cfgString += "DisalignIntervalMs=" + $("#txtDisalignIntervalMs").val() + os.EOL;
        cfgString += "BackgroundColor=" + backgroundColorString + os.EOL;
        cfgString += "LocationType=" + $("#selLocationType").val() + os.EOL;

        return cfgString;
      }
      function deleteItemList(item) {
        $(item).closest('li').remove();
      }
      function getHtmlAddWord(word) {
        var item = "<li><div class='row slim'><div class='col s10'>" + word + "</div><div class='col s2'><a class='waves-effect waves-light- btn slim' onClick='deleteItemList($(this));'>-</a></div></div></li>";
        return item;
      }
      function getHtmlAddColor(colorHex) {
        //
        var item = "<li><div class='row slim'><div class='col s10' style='color: " + colorHex + ";background-color:" + colorHex +";'>" + colorHex + "</div><div class='col s2'><a class='waves-effect waves-light- btn slim' onClick='deleteItemList($(this));'>-</a></div></div></li>";
        return item;
      }
      function addFearWord(word) {
        var item = getHtmlAddWord(word);
        $("#ulFearsWords").append(item);
      }
      function addStrengthWord(word) {
        var item = getHtmlAddWord(word);
        $("#ulStrengthsWords").append(item);
      }
      function addFearColor(color) {
        var item = getHtmlAddColor(color);
        $("#ulFearsColors").append(item);
      }
      function addStrengthColor(color) {
        var item = getHtmlAddColor(color);
        $("#ulStrengthsColors").append(item);
      }
      function getRgbArrayFromElement(input) {
        var hex = $(input).val();
        return getRgbArrayFromHex(hex);
      }
      function getRgbArrayFromHex(hex) {
        hex = hex.substring(1, 7);
        var rgb = new Array();
        rgb.push(parseInt(hex.substring(0, 2), 16));
        rgb.push(parseInt(hex.substring(2, 4), 16));
        rgb.push(parseInt(hex.substring(4, 6), 16));
        return rgb;
      }
    </script>
  </body>
</html>
